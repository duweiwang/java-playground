### 3.1.1 Java 虚拟机
在 Java 虚拟机栈中，最小的执行单位是栈帧。通常一个栈帧由局部变量表、操作数栈、动态链接和方法返回地址信息。每个方法的执行到结束都对应着一个栈帧在虚拟机的入栈和出栈过程。

#### 局部变量表
局部变量表是一组变量值的存储空间，用于存放方法参数和方法内部定义的局部变量。**在 .java 编译成 .class 文件时，已经确定了所需要分配的局部变量表和操作数栈的大小。**

**变量槽**

局部变量表的容量单位是变量槽(Variable Slot)。每个变量槽最多可以存储 32 为长度的空间，所以对于 byte、char、boolean、short、int、float、reference 是占用一个变量槽，
对于 64 位长度的 long 和 double 占用连个变量槽。
使用局部变量表时，通过索引定位对应数据的位置，索引值的范围是从 0 开始至局部变量表最大的变量槽数量。
如果访问的是 32 位数据类型的变量，索引 N 就代表了使用第 N 个变量槽，如果访问的是 64 位数据类型的变量，则说明会同时使用第 N 和 N+1 两个变量槽。
对于两个相邻的共同存放一个 64 位数据的两个变量槽，虚拟机不允许采用任何方式单独访问其中的某一个，如果遇到进行这种操作的字节码，Java 虚拟机就会在类加载的校验阶段中抛出异常。

当一个方法被调用时，会使用局部变量表来完成参数值到参数变量列表的传递过程。如果执行的是对象实例的成员方法（不是 static 修饰的方法），那么局部变量表中第 0 位索引的变量槽默认就是该对象实例的引用(this)，在方法中可以通过关键字 this 来访问到这个隐含的参数。
其余参数则按照参数表顺序排列，参数表分配完毕后，再根据方法体内部定义的局部变量顺序和作用域分配其余的变量槽。
为了尽可能节省栈帧所耗的内存空间，局部变量表中的变量槽是可以重用的，当方法体中定义的局部变量超出其作用域时，该局部变量对应的变量槽就可以交给其他变量来重用。

**变量槽复用**

为了节省栈帧空间，局部变量表中的变量槽是可以复用的，当 PC 计数器的指令执行完毕时，这个变量槽就可以交给其它变量复用。

#### 操作数栈
操作数栈和局部变量表一样，在编译时期就已经确定所需要分配的操作数栈的最大容量。
操作数栈的每一个位置可以是任意的 `Java` 数据类型，`32` 位数据类型所占的栈容量为 `1`，`64` 位数据类型占用的栈容量为 `2`。

当一个方法开始执行的时候，所对应的操作数栈是空的，在方法执行的过程中，会有各种字节码指令往操作数栈中写入和提取内容，也就是出栈 / 入栈操作，最终操作数栈的值也在发生改变。

### 3.1.2 字节码指令
字节码指令由一个标识该指令的操作码和固定数目的参数组成：
- 操作码是一个无符号字节值——即字节代码名，由注记符号标识
- 参数是静态值，确定了精确的指令行为，紧跟在操作码之后
字节码指令大致可以分为两类，一类指令用于局部变量和操作数栈之间传递值。另一类用于对操作数栈的值
进行弹出和计算，并压入栈中。

常见的局部变量操作指令有：
- ILOAD：用于加载 boolean、int、byte、short 和 char 类型的局部变量到操作数栈
- FLOAD：用于加载 float 类型局部变量到操作数栈
- LLOAD：用于加载 lang 类型局部变量到操作数栈，需要加载两个槽 slot
- DLOAD：用于加载 double 类型局部变量到操作数栈，需要加载两个槽 slot
- ALOAD：用于加载非基础类型的局部变量到操作数栈，比如对象之类的

常见的操作数栈指令有：
- ISTORE：从操作数栈弹出 boolean、int、byte、short 和 char 类型的局部变量，并将它存储在由其索引 i 指定的局部变量中
- FSTORE：从操作数栈弹出 float 类型的局部变量，并将它存储在由其索引 i 指定的局部变量中
- LSTORE：从操作数栈弹出 long 类型的局部变量，并将它存储在由其索引 i 指定的局部变量中
- DSTORE：从操作数栈弹出 double 类型的局部变量，并将它存储在由其索引 i 指定的局部变量中
- ASTORE：用于弹出非基础类型的局部变量，并将它存储在由其索引 i 指定的局部变量中

通过上面可以看到，每种对应的数据类型都对应不同的 `XLOAD` 或 `XSTORE`。这是为了保证不会执行
非法的转换。
- 将一个值存储在局部变量表中，在以不同的类型加载它是非法操作，比如存入 ISTORE 类型，使用 FLOAD 加载
- 如果向一个局部变量表中的位置存储一个值，而这个值不同于原来的存储类型，这种操作是合法的

**以上两个特性，意味着：一个局部变量的类型，可能在方法执行期间发生变化。**比如你在方法的最后读取局部变量，可能实际类型
已经发生变化。

[常见字节码指令介绍可以参照 Java 虚拟机指令](https://docs.oracle.com/javase/specs/jvms/se7/html/index.html)



